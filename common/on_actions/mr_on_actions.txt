##########################
# MORGENROETE ON ACTIONS #
##########################

#by Marco Dandolo

######################

# Fires after everyone enters the game from the lobby for the first time for each campaign
# At this point we DO know who the players are
# No root scope set
on_game_started_after_lobby = {
	on_actions = {
		mr_on_game_started_after_lobby
	}
}

mr_on_game_started_after_lobby = {
	effect = {
		### Adds historical Artists to the nations ###
		if = {
			limit = {
				has_game_rule = artists_starting_historical_artists_rule
			}
			artists_starting_artists_set_up_effect = yes	
		}
		### Adds random artists to the nations ###
		else_if = {
			limit = {
				has_game_rule = artists_random_artists_rule
			}

			every_country = {
				limit = {
					has_technology_researched = romanticism
				}
				random_list = {
					2 = {
						trigger = {
							NOT = { has_variable = elgar_composer_var }
						}
						create_new_character_base_effect = { CHARACTER = composer PROJECT = elgar }
						elgar_set_new_composer_as_composer_effect = yes
					}
					2 = {
						trigger = {
							NOT = { has_variable = manzoni_writer_var }
						}
						create_new_character_base_effect = { CHARACTER = writer PROJECT = manzoni }
						manzoni_set_new_writer_as_writer_effect = yes
					}
					2 = {
						trigger = {
							NOT = { has_variable = klimt_painter_var }
						}
						create_new_character_base_effect = { CHARACTER = painter PROJECT = klimt }
						klimt_set_new_painter_as_painter_effect = yes
					}
					1 = {
						trigger = {
							NOT = { has_variable = gaudi_architect_var }
							country_rank < rank_value:major_power
						}
						create_new_character_base_effect = { CHARACTER = architect PROJECT = gaudi }
						gaudi_set_new_architect_as_architect_effect = yes
					}
				}
			}
		}
		### Adds scientists to nations ###
		if = {
			limit = { has_game_rule = academics_random_scientist_rule }

			every_country = {
				limit = {
					any_scope_building = {
						is_building_type = building_university
					}
				}
				random_list = {
					1 = {
						trigger = {
							NOT = { has_variable = tesla_engineer_var }
						}
						create_new_character_base_effect = { CHARACTER = engineer PROJECT = tesla }
						tesla_set_new_engineer_as_engineer_effect = yes
						modifier = {
							if = {
								limit = {
									country_rank < rank_value:major_power
								}
								add = 1
							}
						}
					}
					1 = {
						trigger = {
							NOT = { has_variable = verrier_astronomer_var }
							has_technology_researched = verrier_physics_tech
							any_scope_building = {
								is_building_type = building_verrier_observatory
							}
						}
						create_new_character_base_effect = { CHARACTER = astronomer PROJECT = verrier }
						verrier_set_new_astronomer_as_astronomer_effect = yes
					}
					1 = {
						trigger = {
							NOT = { has_variable = mendelejew_chemist_var }
							has_technology_researched = verrier_chemistry_tech
							any_scope_building = {
								is_building_type = building_verrier_observatory
							}
						}
						create_new_character_base_effect = { CHARACTER = chemist PROJECT = mendelejew }
						mendelejew_set_new_chemist_as_chemist_effect = yes
					}
					1 = {
						trigger = {
							NOT = { has_variable = agassiz_geologist_var }
							has_technology_researched = agassiz_geology_tech
						}
						create_new_character_base_effect = { CHARACTER = geologist PROJECT = agassiz }
						dubois_set_new_geologist_as_geologist_effect = yes
						modifier = {
							if = {
								limit = {
									dubois_has_volcano = yes
								}
								add = 1
							}
						}
					}
					1 = {
						trigger = {
							NOT = { has_variable = dubois_naturalist_var }
							OR = {
								country_rank >= rank_value:major_power #Only really useful with Pacific Expedition
								dubois_has_habitat = yes #Only really useful with habitat
							}
							NOT = {
								c:GBR ?= this #They get Darwin!
							}
						}
						create_new_character_base_effect = { CHARACTER = naturalist PROJECT = dubois }
						dubois_set_new_naturalist_as_naturalist_effect = yes
					}
					1 = {
						trigger = {
							NOT = { has_variable = dubois_paleontologist_var }
							has_technology_researched = prospecting
							AND = {
								country_rank >= rank_value:major_power #Only really useful with Pacific Expedition
								any_scope_state = { #Only really useful with potential formation
									state_region = {
										has_variable = dubois_has_great_formation_var
									}
								}
								any_scope_state = {
									state_region = {
										has_variable = dubois_has_normal_formation_var
									}
								}
							}
						}
						create_new_character_base_effect = { CHARACTER = paleontologist PROJECT = dubois }
						dubois_set_new_paleontologist_as_paleontologist_effect = yes
					}
					1 = {
						trigger = { 
							NOT = { has_variable = panum_physician_var }
							has_technology_researched = medical_degrees
						}
						create_new_character_base_effect = { CHARACTER = physician PROJECT = panum }
						panum_set_new_physician_as_physician_effect = yes
						modifier = {
							if = {
								limit = {
									country_rank < rank_value:major_power
								}
								add = 1
							}
						}
					}
					1 = {
						trigger = {
							NOT = { has_variable = lepsius_archaeologist_var }
							has_technology_researched = lepsius_antiquarianism_tech
							country_rank = rank_value:great_power #Only really useful with Archaeological Expedition, which will be mostly a Great Power thing
							NOT = {
								c:PRU ?= this #They get Lepsius!
							}
						}
						create_new_character_base_effect = { CHARACTER = archaeologist PROJECT = lepsius }
						lepsius_set_new_archaeologist_as_archaeologist_effect = yes
						lepsius_add_start_specialization_effect = yes
					}
					1 = {
						trigger = {
							NOT = { has_variable = lepsius_anthropologist_var }
							has_technology_researched = lepsius_anthropology_tech #Not available at game start, but who knows?
						}
						create_new_character_base_effect = { CHARACTER = anthropologist PROJECT = lepsius }
						lepsius_set_new_anthropologist_as_anthropologist_effect = yes
					}
				}
			}
		}
		### Adds Tech Schools ###
		if = {
			limit = {
				has_game_rule = academics_historical_focus_rule
			}
			academics_add_historical_tech_schools = yes
		}
		### Adds Formations ###
		dubois_add_normal_formations = yes
		if = {
			limit = {
				has_game_rule = dubois_historical_formations_rule
			}
			dubois_add_historical_great_formations = yes
		}
		if = {
			limit = {
				has_game_rule = dubois_random_formations_rule
			}
			dubois_add_random_great_formations = yes
		}
		### Add Uranium ###
		if = {
			limit = {
				has_game_rule = curie_historical_uranium_deposits_rule
			}
			curie_add_historical_uranium_deposits_effect = yes
		}
		if = {
			limit = {
				has_game_rule = curie_random_uranium_deposits_rule
			}
			curie_add_random_uranium_deposits_effect = yes
		}
		### Add Medicinal Plants ###
		ito_add_medicinal_plants_at_game_start_effect = yes
		### Add Olympic Disciplines
		every_country = {
			vikelas_set_national_olympic_discipline_effect = yes
		}

		#Sets up the Constitution Event in Hanover
		c:HAN ?= {
			if = {
				limit = {
					ruler = {
						has_variable = is_billy
					}
				}

				set_global_variable = {
					name = academics_constitution_of_hanover_global_var
					value = 0
				}
			}
		}

		c:JAP ?= {
			if = {
				limit = {
					year > 1818
					year < 1846
					has_state_in_state_region = STATE_KYUSHU
				}

				trigger_event = {
					id = matsuura.102
					days = { 1 30 }
				}
			}
		}

		############################################################ COMMUNITY TOPBAR FRAMEWORK COMPATIBILITY

		mr_add_topbar_elements = yes
	}
}

#Checking the AI

on_monthly_pulse = {
	on_actions = {
		mr_on_monthly_pulse
		mr_on_weekly_pulse
	}
}

mr_on_monthly_pulse = {
	effect = {
		if = {
			limit = {
				NOT = {
					is_target_in_global_variable_list = {
						name = custom_button_list_flag
						target = flag:mr_sidebar_button_arts_sgui
					}
				}
			}
			mr_add_button_to_community_framework_effect = yes
			remove_list_global_variable = {
				name = custom_button_list
				target = ideology:mr_sidebar_button_arts_sgui
			}
		}
	}
}

mr_on_weekly_pulse = {
	effect = {
		com_run_weekly_event_country_effect = {
			weekday = 1
			on_action = mr_on_weekly_pulse_character_deaths
		}
	}
}

# Here the Characters get removed, if they exist but are not alive anymore.
# This effect needs to be in an on_weekly_pulse because otherwise the check does not work,
# because the characters get deleted when they are dead.
mr_on_weekly_pulse_character_deaths = {
	effect = {
		if = {
			limit = {
				has_variable = tesla_engineer_var
				var:tesla_engineer_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = academics.21
		}
		if = {
			limit = {
				has_variable = verrier_astronomer_var
				var:verrier_astronomer_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = academics.22
		}
		if = {
			limit = {
				has_variable = mendelejew_chemist_var
				var:mendelejew_chemist_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = academics.23
		}
		if = {
			limit = {
				has_variable = curie_physicist_var
				var:curie_physicist_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = academics.24
		}
		if = {
			limit = {
				has_variable = agassiz_geologist_var
				var:agassiz_geologist_var = {
					is_character_alive = no
				}
			}
			trigger_event = academics.25
		}
		if = {
			limit = {
				has_variable = dubois_naturalist_var
				var:dubois_naturalist_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = academics.26
		}
		if = {
			limit = {
				has_variable = dubois_paleontologist_var
				var:dubois_paleontologist_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = academics.27
		}
		if = {
			limit = {
				has_variable = theiler_biologist_var
				var:theiler_biologist_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = academics.28
		}
		if = {
			limit = {
				has_variable = lepsius_archaeologist_var
				var:lepsius_archaeologist_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = academics.29
		}
		if = {
			limit = {
				has_variable = lepsius_anthropologist_var
				var:lepsius_anthropologist_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = academics.30
		}
		if = {
			limit = {
				has_variable = panum_physician_var
				var:panum_physician_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = academics.31
		}
		if = {
			limit = {
				has_variable = curtiss_balloonist_var
				var:curtiss_balloonist_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = curtiss.676
			trigger_event = curtiss.677
		}
		if = {
			limit = {
				has_variable = vikelas_racer_var
				var:vikelas_racer_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = vikelas.592
		}
		if = {
			limit = {
				has_variable = douglas_mountaineer_var
				var:douglas_mountaineer_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = athletes.12
		}
		if = {
			limit = {
				has_variable = elgar_composer_var
				var:elgar_composer_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = artists.11
		}
		if = {
			limit = {
				has_variable = manzoni_writer_var
				var:manzoni_writer_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = artists.12
		}
		if = {
			limit = {
				has_variable = klimt_painter_var
				var:klimt_painter_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = artists.13
		}
		if = {
			limit = {
				has_variable = gaudi_architect_var
				var:gaudi_architect_var ?= {
					is_character_alive = no
				}
			}
			trigger_event = artists.14
		}

		#Effects to remove dead people from lists
		if = {
			limit = {
				NOT = { has_global_variable = mr_list_checker_timer_global_var }
			}

			set_global_variable = {
				name = mr_list_checker_timer_global_var
				days = 6
			}

			if = {
				limit = {
					any_in_global_list = {
						variable = mr_travelling_composer_global_list
						is_character_alive = no
					}
				}
				every_in_global_list = {
					variable = mr_travelling_composer_global_list
					limit = { is_character_alive = no }
					
					remove_list_global_variable = {
						name = mr_travelling_composer_global_list
						target = this
					}
				}
			}
			if = {
				limit = {
					has_variable_list = mr_local_writers_list
					any_in_list = {
						variable = mr_local_writers_list
						is_character_alive = no
					}
				}
				every_in_list = {
					variable = mr_local_writers_list
					limit = { is_character_alive = no }
					
					remove_list_variable = {
						name = mr_local_writers_list
						target = this
					}
				}
			}
			if = {
				limit = {
					any_in_global_list = {
						variable = mr_independent_painter_global_list
						is_character_alive = no
					}
				}
				every_in_global_list = {
					variable = mr_independent_painter_global_list
					limit = { is_character_alive = no }
					
					remove_list_global_variable = {
						name = mr_independent_painter_global_list
						target = this
					}
				}
			}
			if = {
				limit = {
					any_in_global_list = {
						variable = mr_independent_architect_global_list
						is_character_alive = no
					}
				}
				every_in_global_list = {
					variable = mr_independent_architect_global_list
					limit = { is_character_alive = no }
					
					remove_list_global_variable = {
						name = mr_independent_architect_global_list
						target = this
					}
				}
			}
		}
	}
}

on_yearly_pulse = {
	on_actions = {
		mr_on_yearly_pulse
	}
}

mr_on_yearly_pulse = {
	effect = {
		### Adds the values for the Topbar
		mr_add_topbar_elements = yes
	}
}

# Root = Releasing Country
# scope:target = Released Country
on_country_released_as_independent = {
	on_actions = {
		mr_on_country_released_as_independent
	}
}

mr_on_country_released_as_independent = {
	effect = {
		scope:target = {
			mr_add_variables = yes
			mr_copy_percentage_of_variables = yes
			pius_copy_old_calender_modifier_other_nations_effect = yes
			manzoni_taste_change_effect = yes
		}
	}
}

# Root = Releasing Country
# scope:target = Released Country
on_country_released_as_own_subject = {
	on_actions = {
		mr_on_country_released_own_subject
	}
}

mr_on_country_released_own_subject = {
	effect = {
		scope:target = {
			mr_add_variables = yes
			mr_copy_percentage_of_variables = yes
			pius_copy_old_calender_modifier_other_nations_effect = yes
			manzoni_taste_change_effect = yes
		}
	}
}

# Root = Releasing Country
# scope:target = Released Country
on_country_released_as_overlord_subject = {
	on_actions = {
		mr_on_country_released_as_overlord_subject
	}
}

mr_on_country_released_as_overlord_subject = {
	effect = {
		scope:target = {
			mr_add_variables = yes
			mr_copy_percentage_of_variables = yes
			pius_copy_old_calender_modifier_other_nations_effect = yes
			manzoni_taste_change_effect = yes
		}
	}
}

# Root = Country
# scope:target = Uprising country
on_revolution_start = {
	on_actions = {
		mr_on_revolution_start
	}
}

mr_on_revolution_start = {
	effect = {
		scope:target = {
			mr_add_variables = yes
			mr_copy_percentage_of_variables_revolution_effect = yes
			pius_copy_old_calender_modifier_revolution_effect = yes
			manzoni_taste_change_effect = yes
		}
	}
}


# Root = Country
# scope:target = Uprising country
on_secession_start = {
	on_actions = {
		mr_on_secession_start
	}
}

mr_on_secession_start = {
	effect = {
		scope:target = {
			mr_add_variables = yes
			mr_copy_percentage_of_variables = yes
			pius_copy_old_calender_modifier_revolution_effect = yes
			manzoni_taste_change_effect = yes
		}
	}
}

# Root = The newly created market
on_create_market = {
	on_actions = {
		mr_on_create_market_variables
	}
}

mr_on_create_market_variables = {
	effect = {
		owner = {
			trigger_event = mr.7
		}
	}
}